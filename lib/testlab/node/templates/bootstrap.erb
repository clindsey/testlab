set -x

# Update APT and ensure our required packages are installed
apt-get -qq -y --force-yes update
apt-get -qq -y --force-yes install lxc chkconfig bridge-utils debootstrap yum iptables isc-dhcp-server bind9 ntpdate ntp apparmor

# Ensure the default lxc networking services are off
chkconfig lxc-net off
service lxc-net stop

# Ensure NTP services are enabled and running
chkconfig ntp on
service ntp start

# Enable ipv4 forwarding
(sysctl net.ipv4.ip_forward | grep "net.ipv4.ip_forward = 1") || (sysctl -w net.ipv4.ip_forward=1)

# Install an iptable NAT rule
(iptables -t nat --list | grep "MASQUERADE  all  --  any    eth0    anywhere             anywhere") || (iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE)

# Ensure the bind key is readable by all
chmod -v 0644 /etc/bind/rndc.key

# Ensure DHCPD and Bind can work together
cat /etc/apparmor.d/local/usr.sbin.dhcpd3 | grep "\/etc\/bind\/"
if [[ $? -ne 0 ]]; then
  cat <<EOF >> /etc/apparmor.d/local/usr.sbin.dhcpd
/etc/bind/ r,
/etc/bind/** r,
EOF
fi

service apparmor restart
service networking restart
service ntp restart
