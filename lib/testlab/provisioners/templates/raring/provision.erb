set -x
set -e

[[ -f /.testlab-raring-provision ]] && exit 0

export DEBIAN_FRONTEND="noninteractive"

# Update APT and ensure our required packages are installed
apt-get -y update
apt-get -y install lxc bridge-utils debootstrap yum iptables iptables-persistent ntpdate ntp pbzip2

# Ensure the default lxc networking services are off
service lxc-net stop || (service lxc-net start ; service lxc-net stop)
echo "manual" | tee /etc/init/lxc-net.override

# Ensure NTP services are enabled and running
service ntp restart || service ntp start

# Enable IPv4 forwarding
sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sysctl -w net.ipv4.ip_forward=1

# Install an iptable NAT rule
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
iptables-save | tee /etc/iptables/rules.v4

touch /.testlab-raring-provision
